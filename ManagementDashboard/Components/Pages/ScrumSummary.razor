@using ManagementDashboard.Components
@using ManagementDashboard.Components.Pages
@using ManagementDashboard.Data.Models

@page "/scrum-summary"

<div class="container py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0"><i class="bi bi-clipboard-check me-2"></i> Scrum Summary</h1>
        <div class="d-flex gap-2 ms-auto">
            <button class="btn btn-primary btn-sm" type="button" @onclick="OpenWorkCaptureModal" aria-label="Add Work Note">
                <i class="bi bi-pencil-square"></i> <span class="d-none d-md-inline">Work Capture</span>
            </button>
            <button class="btn btn-outline-secondary btn-sm" type="button" @onclick="OpenHelpModal" aria-label="How does this work?">
                <i class="bi bi-question-circle"></i> <span class="d-none d-md-inline">How does this work?</span>
            </button>
        </div>
    </div>
    <div class="row mb-3 align-items-end">
        <div class="col-md-4 mb-2">
            <label for="summary-date" class="form-label">Date</label>
            <input id="summary-date" type="date" class="form-control" @bind="SelectedDate" />
        </div>
    </div>
    <ul class="nav nav-tabs mb-3 d-none d-sm-flex" id="scrumTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @(ActiveTab == ScrumTab.Yesterday ? "active" : "")" @onclick="() => SelectTab(ScrumTab.Yesterday)" type="button" role="tab">
                Yesterday <i class="bi bi-info-circle ms-1" title="What did you work on yesterday?"></i>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(ActiveTab == ScrumTab.Today ? "active" : "")" @onclick="() => SelectTab(ScrumTab.Today)" type="button" role="tab">
                Today <i class="bi bi-info-circle ms-1" title="What will you work on today?"></i>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(ActiveTab == ScrumTab.Blockers ? "active" : "")" @onclick="() => SelectTab(ScrumTab.Blockers)" type="button" role="tab">
                Blockers <i class="bi bi-info-circle ms-1" title="What is blocking you?"></i>
            </button>
        </li>
    </ul>
    <div class="mb-3 d-block d-sm-none">
        <div class="btn-group w-100 d-flex flex-wrap" role="group" aria-label="Scrum Tabs">
            <button type="button" class="btn btn-outline-primary btn-sm flex-fill @(ActiveTab == ScrumTab.Yesterday ? "active" : "")" @onclick="() => SelectTab(ScrumTab.Yesterday)">
                Yesterday
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm flex-fill @(ActiveTab == ScrumTab.Today ? "active" : "")" @onclick="() => SelectTab(ScrumTab.Today)">
                Today
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm flex-fill @(ActiveTab == ScrumTab.Blockers ? "active" : "")" @onclick="() => SelectTab(ScrumTab.Blockers)">
                Blockers
            </button>
        </div>
    </div>
    <div class="tab-content p-3 border bg-body rounded-bottom">
        @if (ActiveTab == ScrumTab.Yesterday)
        {
            <div>
                <h5>What did you work on yesterday?</h5>
                <div class="row g-3">
                    @if (YesterdayNotes != null && YesterdayNotes.Any())
                    {
                        @foreach (var note in YesterdayNotes)
                        {
                            <div class="col-12 col-md-6 col-lg-4">
                                <WorkCaptureCard Note="note" OnEdit="HandleWorkCaptureEdit" OnDelete="HandleWorkCaptureDelete" />
                            </div>
                        }
                    }
                    @if (YesterdayTasks != null && YesterdayTasks.Any())
                    {
                        @foreach (var task in YesterdayTasks)
                        {
                            <div class="col-12 col-md-6 col-lg-4">
                                <TaskSummary Task="task" Date="@SelectedDate.AddDays(-1)" />
                            </div>
                        }
                    }
                    @if ((YesterdayTasks == null || !YesterdayTasks.Any()) && (YesterdayNotes == null || !YesterdayNotes.Any()))
                    {
                        <div class="col-12">
                            <p class="text-muted">No entries for yesterday.</p>
                        </div>
                    }
                </div>
            </div>
        }
        else if (ActiveTab == ScrumTab.Today)
        {
            <div>
                <h5>What will you work on today?</h5>
                <div class="row g-3">
                    @if (TodayNotes != null && TodayNotes.Any())
                    {
                        @foreach (var note in TodayNotes)
                        {
                            <div class="col-12 col-md-6 col-lg-4">
                                <WorkCaptureCard Note="note" OnEdit="HandleWorkCaptureEdit" OnDelete="HandleWorkCaptureDelete" />
                            </div>
                        }
                    }
                    @if (TodayTasks != null && TodayTasks.Any())
                    {
                        @foreach (var task in TodayTasks)
                        {
                            <div class="col-12 col-md-6 col-lg-4">
                                <TaskSummary Task="task" Date="@SelectedDate" />
                            </div>
                        }
                    }
                    @if (SelectedDate.Date != DateTime.Now.Date &&(TodayTasks == null || !TodayTasks.Any()) && (TodayNotes == null || !TodayNotes.Any()))
                    {
                        <div class="col-12">
                            <p class="text-muted">No work capture entries found for this date.</p>
                        </div>
                    }
                    @if (SelectedDate.Date == DateTime.Now.Date)
                    {
                        <div class="col-12 mt-4">
                            <NextTasksList />
                        </div>
                    }
                </div>
            </div>
        }
        else if (ActiveTab == ScrumTab.Blockers)
        {
            <div>
                <h5>What is blocking you?</h5>
                <div class="row g-3">
                    @if (BlockedTasks != null && BlockedTasks.Any())
                    {
                        @foreach (var task in BlockedTasks)
                        {
                            <div class="col-12 col-md-6 col-lg-4">
                                <TaskSummary Task="task" Date="@SelectedDate" />
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col-12">
                            <p class="text-muted">No blockers found.</p>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    @if (ShowWorkCaptureModal)
    {
            <WorkCaptureNoteModal 
                Note="NewWorkCaptureNote"
                IsEditMode="false"
                OnCancel="HandleWorkCaptureCancel"
                OnSave="HandleWorkCaptureSave" />
    }
    @if (showHelpModal)
    {
        <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true" style="background:rgba(0,0,0,0.3);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">How does the Scrum Ceremony Summary work?</h5>
                        <button type="button" class="btn-close" aria-label="Close" @onclick="CloseHelpModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <ul class="mb-0 ps-3">
                                    <li><strong>What did you work on yesterday?</strong> – Review your completed tasks and work capture notes from the previous day.</li>
                                    <li><strong>What will you work on today?</strong> – Plan and list your tasks for today, including ongoing and new work.</li>
                                    <li><strong>What is blocking you?</strong> – Identify any blockers or issues that are preventing progress.</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <p>The Scrum Summary automatically pulls:</p>
                                <ul class="mb-0 ps-3">
                                    <li>Tasks updated or completed on the selected date</li>
                                    <li>Work capture notes you log for each day</li>
                                    <li>Blocked tasks for the "Blockers" tab</li>
                                </ul>
                            </div>
                        </div>
                        <div class="alert alert-info small mb-0">
                            Use the <strong>Work Capture</strong> button to log daily notes, research, or events. The summary tabs will auto-populate with your tasks and notes, making stand-ups and reporting effortless.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseHelpModal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

